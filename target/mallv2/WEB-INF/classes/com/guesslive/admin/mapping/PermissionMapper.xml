<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.guesslive.admin.dao.PermissionMapper">
	
	<resultMap type="Permission" id="permissionsMap">
		<id property="id" column="permissionId" />
		<result property="permissionId"   column="menu_code"    jdbcType="VARCHAR" />
		<result property="permissionName" column="permission_name"  jdbcType="VARCHAR" />
		<result property="roleId" 		  column="role_id" 			jdbcType="INTEGER" />
		<result property="roleName" 	  column="role_name" 		jdbcType="VARCHAR" />
		<result property="userId" 		  column="user_id" 			jdbcType="INTEGER" />
	</resultMap>
	
	<resultMap type="Menu" id="menuMap">
		<id property="id" column="menu_id" />
		<result property="menuCode"   column="menu_code"    jdbcType="VARCHAR" />
		<result property="menuName"   column="menu_name"    jdbcType="VARCHAR" />
		<result property="menuUrl" 	  column="menu_url" 	jdbcType="VARCHAR" />
		<result property="parentCode" column="parent_code"  jdbcType="VARCHAR" />
		<result property="menuType"   column="menu_type" 	jdbcType="INTEGER" />
		<result property="orderNum"   column="order_num" 	jdbcType="INTEGER" />
	</resultMap>
	
	<select id="selectPermissionList" parameterType="int" resultMap="permissionsMap">
	   	SELECT
			r.role_id,
			r.role_name,
			p.menu_code,
			p.permission_name
		FROM
			t_role r,
			t_permission p
		WHERE
			r.role_id = p.role_id
		AND EXISTS (
			SELECT
				ur.role_id
			FROM
				t_user_role ur
			WHERE
				ur.user_id = #{userId}
			AND ur.role_id = r.role_id
		)
	</select>
	
	<select id="getMenuList" resultMap="menuMap">
	   	SELECT
			mu.*
		FROM
			t_role r,
			t_user_role ur,
			t_permission p,
			t_menu_url mu
		WHERE
			r.role_id = ur.role_id
		AND p.role_id = r.role_id
		AND mu.menu_code = p.menu_code
		<if test="userId != null and userId != ''">
			AND ur.user_id = #{userId}
		</if>
		<if test="parentCode != null and parentCode != ''">
			AND mu.parent_code = #{parentCode}
		</if>
		<if test="menuType != null and menuType != ''">
			AND mu.menu_type = #{menuType}
		</if>
	</select>
</mapper>