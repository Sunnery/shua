<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.guesslive.admin.dao.MenuMapper">
	
	<resultMap type="Menu" id="menuMap">
		<id property="id" column="menu_id" />
		<result property="menuCode"   column="menu_code"    jdbcType="VARCHAR" />
		<result property="menuName"   column="menu_name"    jdbcType="VARCHAR" />
		<result property="menuUrl" 	  column="menu_url" 	jdbcType="VARCHAR" />
		<result property="parentCode" column="parent_code"  jdbcType="VARCHAR" />
		<result property="menuType"   column="menu_type" 	jdbcType="INTEGER" />
		<result property="orderNum"   column="order_num" 	jdbcType="INTEGER" />
	</resultMap>
	
	<select id="getRootMenus" resultMap="menuMap">
	   	SELECT
			mu.*
		FROM
			t_menu_url mu
		WHERE mu.parent_code = 0
		AND mu.menu_type = #{menuType}
		order by mu.order_num
	</select>
	
	<select id="getChildMenus" resultMap="menuMap">
		SELECT
			mu.*
		FROM
			t_menu_url mu
		WHERE mu.parent_code = #{parentCode}
		order by mu.order_num
	</select>
	
	<select id="addMenus" parameterType="Menu">
		INSERT INTO t_menu_url (
			menu_code,
			menu_name,
			menu_url,
			menu_type,
			parent_code,
			create_time,
			update_time,
			order_num
		)
		VALUE
			(
				(select IFNULL(max(t.menu_code)+1,case when t.parent_code = 0 then '10' else CONCAT(#{parentCode},'01') end) from t_menu_url t where t.parent_code = #{parentCode}),
				#{menuName},
				#{menuUrl},
				#{menuType},
				#{parentCode},
				SYSDATE(),
				SYSDATE(),
				#{orderNum}
			)
	</select>
	
	<select id="deleteMenus">
		DELETE FROM t_menu_url WHERE MENU_CODE = #{menuCode}
	</select>
	
	<select id="modifyMenus" parameterType="Menu">
		UPDATE t_menu_url t
			SET t.menu_name = #{menuName},
			 t.menu_type = #{menuType},
			 t.menu_url = #{menuUrl},
			 t.parent_code = #{parentCode},
			 t.update_time = SYSDATE(),
			 t.order_num = #{orderNum}
		WHERE
			t.menu_code = #{menuCode}
	</select>
	
	<select id="getMenuList" resultMap="menuMap">
	   	SELECT
			mu.*
		FROM
			t_menu_url mu	
		WHERE mu.parent_code = #{parentCode}
			<if test="agentId != null and agentId != ''">
				and mu.menu_code in (
					select p.menu_code from t_role r,t_permission p where r.agent_id =#{agentId} and r.role_id = p.role_id
				)
		order by mu.order_num
			</if>
	</select>
	
</mapper>