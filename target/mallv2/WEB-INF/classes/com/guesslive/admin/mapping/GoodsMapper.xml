<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.guesslive.admin.dao.GoodsMapper" >
  <resultMap id="BaseResultMap" type="Goods" >
    <id column="goodsid" property="goodsid" jdbcType="INTEGER" />
    <result column="goodsname" property="goodsname" jdbcType="VARCHAR" />
    <result column="agentid" property="agentid" jdbcType="INTEGER" />
    <result column="goodssn" property="goodssn" jdbcType="VARCHAR" />
    <result column="cate" property="cate" jdbcType="VARCHAR" />
    <result column="subcate" property="subcate" jdbcType="VARCHAR" />
    <result column="subcateid" property="subcateid" jdbcType="INTEGER" />
    <result column="status" property="status" jdbcType="TINYINT" />
    <result column="marketprice" property="marketprice" jdbcType="REAL" />
    <result column="sugprice" property="sugprice" jdbcType="REAL" />
    <result column="params" property="params" jdbcType="LONGVARCHAR" />
    <result column="preimgurls" property="preimgurls" jdbcType="LONGVARCHAR" />
    <result column="pictextdetail" property="pictextdetail" jdbcType="LONGVARCHAR" />
    <result column="brandid" property="brandid" jdbcType="INTEGER" />
    <result column="isspecenabled" property="isspecenabled" jdbcType="TINYINT" />
    <association property="product" javaType="Product" resultMap="productMap"/>  
  </resultMap>
  
  
    <resultMap id="productMap" type="Product">
        <id property="id" column="pid" />
        <result property="sn" column="sn" />
        <result property="store" column="store" />
        <result property="specs" column="specs" />
    </resultMap>
	     
	<select id="getGoodsCount" resultType="int">
     	SELECT
			count(1)
		FROM
			t_goods a
 		where a.status != 0
		<if test="status !=null and status !='' ">
			and a.status = #{status}
		</if>
		<if test="goodssn !=null and goodssn !='' ">
			and a.goodssn = #{goodssn}
		</if>
		<if test="shortname !=null and shortname !='' ">
			and a.shortname = #{shortname}
		</if>
		<if test="goodsname !=null and goodsname !='' ">
			and a.goodsname like concat('%',#{goodsname},'%')
		</if>
     </select>
     
  	<update id="updateByPrimaryKeySelective" parameterType="Goods" >
	    update t_goods
	    <set >
	      <if test="iconurl != null" >
	        iconurl = #{iconurl,jdbcType=VARCHAR},
	      </if>
	      <if test="saleprice != null" >
	        saleprice = #{saleprice,jdbcType=REAL},
	      </if>
	      <if test="activitytype != null" >
	        activitytype = #{activitytype,jdbcType=INTEGER},
	      </if>
	      <if test="status != null" >
	        status = #{status,jdbcType=TINYINT},
	      </if>
	      <if test="updatetime != null" >
	        updatetime = #{updatetime,jdbcType=TIMESTAMP},
	      </if>
	    </set>
	    where goodsid = #{goodsid,jdbcType=INTEGER}
	</update>
	
	<update id="updateByPrimaryKey" parameterType="Goods" >
	    update t_goods set
	        saleprice = #{saleprice,jdbcType=REAL},
	        activitytype = #{activitytype,jdbcType=INTEGER},
	        status = #{status,jdbcType=TINYINT},
	        updatetime = #{updatetime,jdbcType=TIMESTAMP}
	    where goodsid = #{goodsid,jdbcType=INTEGER}
	</update>
	
	<!-- 修改活动专区下的商品状态，活动类型-->
	<update id="updateByAreaId" parameterType="java.util.Map" >
	    update t_goods g set g.activitytype=#{activitytype}, g.status = #{status} , g.updatetime = #{updatetime}
	    where g.goodsid in (select ag.goodsid from t_area_goods ag where ag.areaid = #{areaid,jdbcType=INTEGER} )
	</update>
	
	  <select id="selectExport" parameterType="Goods" resultType="Goods" >
	    SELECT
			CASE WHEN (select MIN(t.marketprice) from t_product t where t.goodsid = a.goodsid)=(select max(t.marketprice) from t_product t where t.goodsid = a.goodsid) THEN (select max(t.marketprice) from t_product t where t.goodsid = a.goodsid) ELSE (select CONCAT(MIN(t.marketprice),'-',max(t.marketprice)) from t_product t where t.goodsid = a.goodsid) END marketprice,
			CASE WHEN (select MIN(t.saleprice) from t_product t where t.goodsid = a.goodsid)=(select max(t.saleprice) from t_product t where t.goodsid = a.goodsid) THEN (select max(t.saleprice) from t_product t where t.goodsid = a.goodsid) ELSE (select CONCAT(MIN(t.saleprice),'-',max(t.saleprice)) from t_product t where t.goodsid = a.goodsid) END saleprice,
			(select sum(t.stock) from t_product t where t.goodsid = a.goodsid) stock,
			CASE WHEN (select MIN(t.settleprice) from t_product t where t.goodsid = a.goodsid)=(select max(t.settleprice) from t_product t where t.goodsid = a.goodsid) THEN (select max(t.settleprice) from t_product t where t.goodsid = a.goodsid) ELSE (select CONCAT(MIN(t.settleprice),'-',max(t.settleprice)) from t_product t where t.goodsid = a.goodsid) END settleprice,
			CASE WHEN (select MIN(t.activeprice) from t_product t where t.goodsid = a.goodsid)=(select max(t.activeprice) from t_product t where t.goodsid = a.goodsid) THEN (select max(t.activeprice) from t_product t where t.goodsid = a.goodsid) ELSE (select CONCAT(MIN(t.activeprice),'-',max(t.activeprice)) from t_product t where t.goodsid = a.goodsid) END activeprice,
			IFNULL((select t.brandname from t_brand t where t.brandcode = a.brandCode),'') brandname,
			(select t.catename from t_goods_category t where t.id = a.cateCode)cateName,
			(select t.catename from t_goods_category t where t.id = a.subcateCode)subcateName,
			(select point from t_agent_point t where t.pointId = a.pointid) point,
			(select t.agentname from t_agent t where t.id = a.agentid)agentname,
			a.*
		FROM
			t_goods a
 		where a.status != 0
		<if test="goods.status !=null and goods.status !='' ">
			and a.status = #{goods.status}
		</if>
		<if test="goods.goodssn !=null and goods.goodssn !='' ">
			and a.goodssn = #{goods.goodssn}
		</if>
		<if test="goods.shortname !=null and goods.shortname !='' ">
			and a.shortname = #{goods.shortname}
		</if>
		<if test="goods.goodsname !=null and goods.goodsname !='' ">
			and a.goodsname like concat('%',#{goods.goodsname},'%')
		</if>
		<if test="goods.goodsid !=null and goods.goodsid !='' ">
			and a.goodsid like concat('%',#{goods.goodsid},'%')
		</if>
		order by createtime desc
  </select>
	
	<!-- 查询规格和规格值列表 -->
	<resultMap type="Spec" id="spec">
		<id column="id" property="id" />
		<result column="name" property="name" />
		<result column="isdefault" property="isdefault" />
		<collection property="specValues" ofType="SpecValue">
			<id column="specid" property="specid" />
			<result column="vid" property="vid" />
			<result column="value" property="value" />
			<result column="isdefaultvalue" property="isdefaultvalue" />
		</collection>
	</resultMap>
	
	<!-- 查询规格和规格值列表 -->
	<select id="querySpecList" resultMap="spec">
		select
		c.id,c.name,c.isdefault,v.id vid,v.`value`,v.isdefaultvalue,c.agentid from
		t_spec c
		,t_spec_value v
		,t_category_spec cs
		where c.id = v.specid and
		(c.agentid = #{agentid} or c.agentid = 0)
		and cs.sid = c.id
		and cs.gcid = #{subcateid};
	</select>
  
	<resultMap type="ProductSpec" id="productspec">
		<id column="productid" property="productid" />
		<result column="sn" property="sn" />
		<result column="store" property="store" />
		<collection property="specs" ofType="Spec">
			<id column="specid" property="id" />
			<result column="name" property="name" />
		</collection>
		<collection property="specValues" ofType="SpecValue">
			<result column="svid" property="vid" />
			<result column="value" property="value" />
		</collection>
	</resultMap>

	<!-- 查询规格和规格值列表 -->
	<resultMap type="Spec" id="specs">
		<id column="id" property="id" />
		<result column="name" property="name" />
		<result column="isdefault" property="isdefault" />
		<collection property="specValues" ofType="SpecValue">
			<id column="specid" property="specid" />
			<result column="vid" property="vid" />
			<result column="value" property="value" />
			<result column="isdefaultvalue" property="isdefaultvalue" />
		</collection>
	</resultMap>

	<!-- 查货品规格 -->
	<select id="queryProductSpecList" resultMap="productspec">
		SELECT
		t.specid,t.svid,t1.`name`,t2.`value`,p.id productid,p.sn,p.store FROM t_goods_spec t
		,t_product p,t_spec t1,t_spec_value t2
		where t.productid = p.id 
		and t.specid = t1.id 
		and t.svid = t2.id
		and t.goodsid = #{goodsid}
	</select>

	<!-- 查询规格和规格值列表 -->
	<select id="querySpecLists" resultMap="specs">
		select
		c.id,c.name,c.isdefault,v.id vid,v.`value`,v.isdefaultvalue from
		t_spec c
		,t_spec_value v
		,t_category_spec cs
		where c.id = v.specid and
		(c.agentid =
		#{agentid} or c.agentid = 0)
		and cs.sid = c.id
		and cs.gcid = #{gcid}
	</select>

	<delete id="deleteSpecValueById">
		delete from t_spec_value where id = #{id}
	</delete>

	<insert id="addSpecValue" parameterType="SpecValue">
		insert into t_spec_value
		(specid,value) values
		(${specid},'${value}');
	</insert>

	<select id="querySpecValueList" resultType="SpecValue">
		select t.id
		vid,t.isdefaultvalue from t_spec_value t where t.specid = #{specid}
	</select>

	<insert id="insertGoods" parameterType="Goods" useGeneratedKeys="true" keyProperty="goodsid" >
		insert into t_goods
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="goodssn != null">
				goodssn,
			</if>
			<if test="goodsname != null">
				goodsname,
			</if>
			<if test="shortname != null">
				shortname,
			</if>
			<if test="brandCode != null">
				brandCode,
			</if>
			<if test="agentid != null">
				agentid,
			</if>
			<if test="iconurl != null ">
				iconurl,
			</if>
			<if test="cateCode != null ">
				cateCode,
			</if>
			<if test="cateName != null ">
				cateName,
			</if>
			<if test="subcateCode != null ">
				subcateCode,
			</if>
			<if test="monsalecount != null ">
				monsalecount,
			</if>
			<if test="sumsalecount != null ">
				sumsalecount,
			</if>
			<if test="isspecenabled != null ">
				isspecenabled,
			</if>
			<if test="settleratetype != null ">
				settleratetype,
			</if>
			<if test="activitytype != null ">
				activitytype,
			</if>
			<if test="params != null ">
				params,
			</if>
			<if test="specs != null ">
				specs,
			</if>
			<if test="preimgurls != null ">
				preimgurls,
			</if>
			<if test="pictextdetail != null ">
				pictextdetail,
			</if>
			<if test="status != null ">
				status,
			</if>
			<if test="source != null ">
				source,
			</if>
			<if test="excode != null ">
				excode,
			</if>
			<if test="createTime != null ">
				createTime,
			</if>
			<if test="createrId != null ">
				createrId,
			</if>
			<if test="updateTime != null ">
				updateTime,
			</if>
			<if test="updaterId != null ">
				updaterId,
			</if>
			<if test="postage != null ">
				postage,
			</if>
			<if test="transport != null ">
				transport,
			</if>
			<if test="specContent != null ">
				specContent,
			</if>
			<if test="pointid != null ">
				pointid,
			</if>
			<if test="settletype != null ">
				settletype,
			</if>
			<if test="specContentDetail != null ">
				specContentDetail,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="goodssn != null">
				#{goodssn},
			</if>
			<if test="goodsname != null">
				#{goodsname},
			</if>
			<if test="shortname != null">
				#{shortname},
			</if>
			<if test="brandCode != null">
				#{brandCode},
			</if>
			<if test="agentid != null">
				#{agentid},
			</if>
			<if test="iconurl != null ">
				#{iconurl},
			</if>
			<if test="cateCode != null ">
				#{cateCode},
			</if>
			<if test="cateName != null ">
				#{cateName},
			</if>
			<if test="subcateCode != null ">
				#{subcateCode},
			</if>
			<if test="monsalecount != null ">
				#{monsalecount},
			</if>
			<if test="sumsalecount != null ">
				#{sumsalecount},
			</if>
			<if test="isspecenabled != null ">
				#{isspecenabled},
			</if>
			<if test="activitytype != null ">
				#{activitytype},
			</if>
			<if test="params != null ">
				#{params},
			</if>
			<if test="specs != null ">
				#{specs},
			</if>
			<if test="preimgurls != null ">
				#{preimgurls},
			</if>
			<if test="pictextdetail != null ">
				#{pictextdetail},
			</if>
			<if test="status != null ">
				#{status},
			</if>
			<if test="source != null ">
				#{source},
			</if>
			<if test="excode != null ">
				#{excode},
			</if>
			<if test="createTime != null ">
				#{createTime},
			</if>
			<if test="createrId != null ">
				#{createrId},
			</if>
			<if test="updateTime != null ">
				#{updateTime},
			</if>
			<if test="updaterId != null ">
				#{updaterId},
			</if>
			<if test="postage != null ">
				#{postage},
			</if>
			<if test="transport != null ">
				#{transport},
			</if>
			<if test="specContent != null ">
				#{specContent},
			</if>
			<if test="pointid != null ">
				#{pointid},
			</if>
			<if test="settletype != null ">
				#{settletype},
			</if>
			<if test="specContentDetail != null ">
				#{specContentDetail},
			</if>
		</trim>
	</insert>

	<insert id="insertProduct" parameterType="Product" useGeneratedKeys="true" keyProperty="goodsid" >
		insert into t_product
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="goodsid != null">
				goodsid,
			</if>
			<if test="skuCode != null">
				skuCode,
			</if>
			<if test="source != null">
				source,
			</if>
			<if test="excode != null">
				excode,
			</if>
			<if test="iconUrl != null">
				iconUrl,
			</if>
			<if test="stock != null">
				stock,
			</if>
			<if test="marketprice != null">
				marketprice,
			</if>
			<if test="saleprice != null and  saleprice !=''" >
				saleprice,
			</if>
			<if test="settleprice != null">
				settleprice,
			</if>
			<if test="createTime != null">
				createTime,
			</if>
			<if test="createrId != null">
				createrId,
			</if>
			<if test="updateTime != null">
				updateTime,
			</if>
			<if test="updaterId != null">
				updaterId,
			</if>
			<if test="specNameA != null">
				specNameA,
			</if>
			<if test="specValueA != null">
				specValueA,
			</if>
			<if test="specNameB != null">
				specNameB,
			</if>
			<if test="specValueB != null">
				specValueB,
			</if>
			<if test="status != null">
				status,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="goodsid != null">
				#{goodsid},
			</if>
			<if test="skuCode != null">
				#{skuCode},
			</if>
			<if test="source != null">
				#{source},
			</if>
			<if test="excode != null">
				#{excode},
			</if>
			<if test="iconUrl != null">
				#{iconUrl},
			</if>
			<if test="stock != null">
				#{stock},
			</if>
			<if test="marketprice != null">
				#{marketprice},
			</if>
			<if test="saleprice != null and  saleprice !=''">
				#{saleprice},
			</if>
			<if test="settleprice != null">
				#{settleprice},
			</if>
			<if test="createTime != null">
				#{createTime},
			</if>
			<if test="createrId != null">
				#{createrId},
			</if>
			<if test="updateTime != null">
				#{updateTime},
			</if>
			<if test="updaterId != null">
				#{updaterId},
			</if>
			<if test="specNameA != null">
				#{specNameA},
			</if>
			<if test="specValueA != null">
				#{specValueA},
			</if>
			<if test="specNameB != null">
				#{specNameB},
			</if>
			<if test="specValueB != null">
				#{specValueB},
			</if>
			<if test="status != null">
				#{status},
			</if>
		</trim>
	</insert>

	<update id="updateGoods" parameterType="Goods">
		update t_goods
		<set>
			<if test="goodssn != null">
				goodssn = #{goodssn},
			</if>
			<if test="goodsname != null">
				goodsname = #{goodsname},
			</if>
			<if test="shortname != null">
				shortname = #{shortname},
			</if>
			<if test="brandCode != null">
				brandCode = #{brandCode},
			</if>
			<if test="agentid != null">
				agentid = #{agentid},
			</if>
			<if test="iconurl != null">
				iconurl = #{iconurl},
			</if>
			<if test="cateCode != null">
				cateCode = #{cateCode},
			</if>
			<if test="cateName != null">
				cateName = #{cateName},
			</if>
			<if test="subcateCode != null">
				subcateCode = #{subcateCode},
			</if>
			<if test="monsalecount != null">
				monsalecount = #{monsalecount},
			</if>
			<if test="sumsalecount != null">
				sumsalecount = #{sumsalecount},
			</if>
			<if test="isspecenabled != null">
				isspecenabled = #{isspecenabled},
			</if>
			<if test="settleratetype != null">
				settleratetype = #{settleratetype},
			</if>
			<if test="activitytype != null">
				activitytype = #{activitytype},
			</if>
			<if test="params != null">
				params = #{params},
			</if>
			<if test="pictextdetail != null">
				pictextdetail = #{pictextdetail},
			</if>
			<if test="status != null">
				status = ${status},
			</if>
			<if test="source != null">
				source = #{source},
			</if>
			<if test="excode != null">
				excode = #{excode},
			</if>
			<if test="createrId != null">
				createrId = #{createrId},
				createTime = sysDate(),
			</if>
			<if test="updaterId != updaterId">
				updaterId = #{updaterId},
				updateTime = sysDate(),
			</if>
			<if test="postage != null">
				postage = #{postage},
			</if>
			<if test="transport != null">
				transport = #{transport},
			</if>
			<if test="specContent != null">
				specContent = #{specContent},
			</if>
			<if test="pointid != null">
				pointid = #{pointid},
			</if>
			<if test="settletype != null">
				settletype = #{settletype},
			</if>
			<if test="specContentDetail != null">
				specContentDetail = #{specContentDetail},
			</if>
			<if test="preimgurls != null">
				preimgurls = #{preimgurls},
			</if>
			<if test="status = 3 or status = 4 ">
				approvedesc = #{approvedesc},
				approvetime = sysDate(),
				approverId = #{updaterId},
			</if>
		</set>
		where goodsid=#{goodsid}
	</update>

	<update id="updateProduct" parameterType="Product">
		update t_product
		<set>
			<if test="source != null and source != ''">
				source = #{source},
			</if>
			<if test="iconUrl != null and iconUrl != ''">
				iconUrl = #{iconUrl},
			</if>
			<if test="stock != null and stock != ''">
				stock = #{stock},
			</if>
			<if test="marketprice != null and marketprice != ''">
				marketprice = #{marketprice},
			</if>
			<if test="saleprice != null and saleprice != ''">
				saleprice = #{saleprice},
			</if>
			<if test="settleprice != null and settleprice != ''">
				settleprice = #{settleprice},
			</if>
			<if test="createTime != null and createTime != ''">
				createTime = #{createTime},
			</if>
			<if test="createrId != null and createrId != ''">
				createrId = #{createrId},
			</if>
			<if test="updateTime != null and updateTime != ''">
				updateTime = #{updateTime},
			</if>
			<if test="updaterId != null and updaterId != ''">
				updaterId = #{updaterId},
			</if>
			<if test="specNameA != null and specNameA != ''">
				specNameA = #{specNameA},
			</if>
			<if test="specValueA != null and specValueA != ''">
				specValueA = #{specValueA},
			</if>
			<if test="specNameB != null and specNameB != ''">
				specNameB = #{specNameB},
			</if>
			<if test="specValueB != null and specValueB != ''">
				specValueB = #{specValueB},
			</if>
			<if test="status != null and status != ''">
				status = #{status},
			</if>
			<if test="activeprice != null and activeprice != ''">
				activeprice = #{activeprice},
			</if>
		</set>
		where id=#{id}
	</update>

	<update id="deleteProduct" parameterType="Product">
		delete from t_product where id not in (${ids}) and goodsid = #{goodsid}
	</update>

	<select id="getGoodsList" parameterType="Goods" resultType="Goods">
		SELECT
			CASE WHEN (select MIN(t.marketprice) from t_product t where t.goodsid = a.goodsid)=(select max(t.marketprice) from t_product t where t.goodsid = a.goodsid) THEN (select max(t.marketprice) from t_product t where t.goodsid = a.goodsid) ELSE (select CONCAT(MIN(t.marketprice),'-',max(t.marketprice)) from t_product t where t.goodsid = a.goodsid) END marketprice,
			CASE WHEN (select MIN(t.saleprice) from t_product t where t.goodsid = a.goodsid)=(select max(t.saleprice) from t_product t where t.goodsid = a.goodsid) THEN (select max(t.saleprice) from t_product t where t.goodsid = a.goodsid) ELSE (select CONCAT(MIN(t.saleprice),'-',max(t.saleprice)) from t_product t where t.goodsid = a.goodsid) END saleprice,
			(select sum(t.stock) from t_product t where t.goodsid = a.goodsid) stock,
			CASE WHEN (select MIN(t.settleprice) from t_product t where t.goodsid = a.goodsid)=(select max(t.settleprice) from t_product t where t.goodsid = a.goodsid) THEN (select max(t.settleprice) from t_product t where t.goodsid = a.goodsid) ELSE (select CONCAT(MIN(t.settleprice),'-',max(t.settleprice)) from t_product t where t.goodsid = a.goodsid) END settleprice,
			CASE WHEN (select MIN(t.activeprice) from t_product t where t.goodsid = a.goodsid)=(select max(t.activeprice) from t_product t where t.goodsid = a.goodsid) THEN (select max(t.activeprice) from t_product t where t.goodsid = a.goodsid) ELSE (select CONCAT(MIN(t.activeprice),'-',max(t.activeprice)) from t_product t where t.goodsid = a.goodsid) END activeprice,
			IFNULL((select t.brandname from t_brand t where t.brandcode = a.brandCode),'') brandname,
			(select t.catename from t_goods_category t where t.id = a.cateCode)cateName,
			(select t.catename from t_goods_category t where t.id = a.subcateCode)subcateName,
			(select point from t_agent_point t where t.pointId = a.pointid) point,
			(select t.agentname from t_agent t where t.id = a.agentid)agentname,
			(select name from t_sys_user t where t.id = a.approverId) approverName,
			a.*
		FROM
			t_goods a
 		where a.status != 0
		<if test="goods.status !=null and goods.status !='' ">
			and a.status = #{goods.status}
		</if>
		<if test="goods.goodssn !=null and goods.goodssn !='' ">
			and a.goodssn = #{goods.goodssn}
		</if>
		<if test="goods.shortname !=null and goods.shortname !='' ">
			and a.shortname = #{goods.shortname}
		</if>
		<if test="goods.goodsname !=null and goods.goodsname !='' ">
			and a.goodsname like concat('%',#{goods.goodsname},'%')
		</if>
		<if test="goods.goodsid !=null and goods.goodsid !='' ">
			and a.goodsid like concat('%',#{goods.goodsid},'%')
		</if>
		<if test="goods.agentname !=null and goods.agentname !='' ">
			and a.agentid in (select id from t_agent t where t.agentname like concat('%',#{goods.agentname},'%'))
		</if>
		order by createtime desc
		limit #{start},#{rows}
	</select>

	<select id="getProductList" parameterType="Product" resultType="Product">
		SELECT * FROM t_product a where a.goodsid = #{goodsid} and a.status = 1 order by createtime desc
	</select>

</mapper>